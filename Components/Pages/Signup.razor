@page "/Signup"

@inject MySqlConnection Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthenticationStateProvider

@rendermode InteractiveServer

<h3>@(isSignupMode ? "Create Account" : "Login")</h3>

<div class="mb-3">
    <button class="btn btn-link" @onclick="() => SwitchMode(false)">Login</button>
    <button class="btn btn-link" @onclick="() => SwitchMode(true)">Sign Up</button>
</div>

@if (isSignupMode)
{
    <!-- SIGNUP FORM -->
    <div>
        <input @bind="firstName" placeholder="First Name" class="form-control mt-2" />
        <input @bind="lastName" placeholder="Last Name" class="form-control mt-2" />
        <input @bind="schoolId" placeholder="School ID" class="form-control mt-2" />

        <input @bind="username" placeholder="Username" class="form-control mt-2" />
        <input @bind="email" placeholder="Email" class="form-control mt-2" />
        <input @bind="password" type="password" placeholder="Password" class="form-control mt-2" />

        <select @bind="role" class="form-control mt-2">
            <option value="student">Student</option>
            <option value="faculty">Faculty</option>
        </select>

        <button type="button" class="btn btn-primary mt-3" @onclick="CreateUser">
            Create Account
        </button>

        <p class="text-danger">@signupError</p>
    </div>
}
else
{
    <!-- LOGIN FORM -->
    <div>
        <input @bind="username" placeholder="Username" class="form-control mt-2" />
        <input @bind="password" type="password" placeholder="Password" class="form-control mt-2" />

        <button class="btn btn-primary mt-3" @onclick="DoLogin">
            Login
        </button>

        <p class="text-danger">@loginError</p>
    </div>
}

@code {
    // --- FORM FIELDS ---
    string firstName = "";
    string lastName = "";
    string schoolId = "";

    string username = "";
    string password = "";
    string email = "";
    string role = "student";

    bool isSignupMode = false;

    string loginError = "";
    string signupError = "";

    void SwitchMode(bool signup)
    {
        isSignupMode = signup;
        loginError = "";
        signupError = "";

        firstName = "";
        lastName = "";
        schoolId = "";
        username = "";
        password = "";
        email = "";
        role = "student";
    }

    private async Task CreateUser()
    {
        signupError = "Processing...";

        try
        {
            await Db.OpenAsync();

            // --- ROLE VALIDATION ---
            if (role != "student" && role != "faculty")
            {
                signupError = "Invalid role selection.";
                return;
            }

            // --- BASIC FIELD VALIDATION ---
            if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password) ||
                string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(firstName) ||
                string.IsNullOrWhiteSpace(lastName) || string.IsNullOrWhiteSpace(schoolId))
            {
                signupError = "All fields are required.";
                return;
            }

            string hash = BCrypt.HashPassword(password);

            var cmd = new MySqlCommand(
                @"INSERT INTO users 
                    (username, email, password, role, create_datetime, first_name, last_name, school_id) 
                  VALUES 
                    (@u, @e, @p, @r, NOW(), @fn, @ln, @sid)",
                Db);

            cmd.Parameters.AddWithValue("@u", username);
            cmd.Parameters.AddWithValue("@e", email);
            cmd.Parameters.AddWithValue("@p", hash);
            cmd.Parameters.AddWithValue("@r", role);
            cmd.Parameters.AddWithValue("@fn", firstName);
            cmd.Parameters.AddWithValue("@ln", lastName);
            cmd.Parameters.AddWithValue("@sid", schoolId);

            int rows = await cmd.ExecuteNonQueryAsync();

            if (rows > 0)
            {
                signupError = "";
                isSignupMode = false; // switch to login
            }
            else
            {
                signupError = "Insert returned 0 rows.";
            }
        }
        catch (Exception ex)
        {
            signupError = $"ERROR: {ex.Message}";
        }
        finally
        {
            await Db.CloseAsync();
        }
    }

    private async Task DoLogin()
    {
        loginError = "Processing...";

        try
        {
            await Db.OpenAsync();

            var cmd = new MySqlCommand(
                "SELECT id, password, role FROM users WHERE username=@u LIMIT 1", Db);

            cmd.Parameters.AddWithValue("@u", username);

            var reader = await cmd.ExecuteReaderAsync();
            if (!await reader.ReadAsync())
            {
                loginError = "Invalid username or password.";
                return;
            }

            int userId = reader.GetInt32("id");
            string storedHash = reader.GetString("password");
            string userRole = reader.GetString("role");

            if (!BCrypt.Verify(password, storedHash))
            {
                loginError = "Invalid username or password.";
                return;
            }

            // success — log in
            if (AuthenticationStateProvider is AuthStateProvider auth)
                auth.SignIn(userId, username, userRole);

            Nav.NavigateTo("/");
        }
        catch (Exception ex)
        {
            loginError = $"ERROR: {ex.Message}";
        }
        finally
        {
            await Db.CloseAsync();
        }
    }
}
