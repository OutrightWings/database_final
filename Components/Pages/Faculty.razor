@page "/Faculty"
@attribute [Authorize(Roles = "faculty")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims;
@inject AuthenticationStateProvider AuthStateProvider
@inject MySqlConnection Db

@rendermode InteractiveServer

<h3>Faculty - Student Information</h3>

<CascadingAuthenticationState>
    <AuthorizeView Roles="faculty">
        <Authorized Context="authContext">

            <h4>Lookup Student by Code</h4>
            <input type="text" @bind="searchCode" placeholder="Enter student code" class="form-control w-25 d-inline" />
            <button class="btn btn-primary ms-2" @onclick="LoadStudentByCode">Load Student</button>

            @if (studentId == null)
            {
                <p class="text-muted mt-2">Enter a valid code to load student information.</p>
            }
            else
            {
                <h4>Student Information</h4>
                <p><strong>Student ID:</strong> @studentId</p>

                <h4 class="mt-4">Student Documents</h4>

                @if (loadingDocuments)
                {
                    <p>Loading...</p>
                }
                else if (documents.Count == 0)
                {
                    <p>No documents uploaded.</p>
                }
                else
                {
                    <ul>
                        @foreach (var doc in documents)
                        {
                            <li>
                                <a href="@doc.FilePath" download="@doc.Filename">@doc.Filename</a> 
                                (Uploaded: @doc.UploadedAt.ToString("g"))
                            </li>
                        }
                    </ul>
                }

                <h5>Upload Document for Student</h5>
                <InputFile OnChange="OnFilesSelected" multiple />

                @if (selectedFiles.Count > 0)
                {
                    <ul>
                        @foreach (var file in selectedFiles)
                        {
                            <li>@file.Name (@file.Size / 1024) KB</li>
                        }
                    </ul>

                    <button class="btn btn-primary" @onclick="UploadSelectedFiles">Upload</button>
                }

                <h4 class="mt-4">Student Approval Codes</h4>
                @if (loadingCodes)
                {
                    <p>Loading...</p>
                }
                else if (codes.Count == 0)
                {
                    <p>No codes generated yet.</p>
                }
                else
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Date Generated</th>
                                <th>Approved</th>
                                <th>Date Approved</th>
                                <th>Approved By</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in codes)
                            {
                                <tr>
                                    <td>@c.Code</td>
                                    <td>@c.DateGenerated.ToString("g")</td>
                                    <td>@(c.Approved ? "Yes" : "No")</td>
                                    <td>@(c.DateApproved?.ToString("g") ?? "-")</td>
                                    <td>@(c.ApprovalUsername ?? "-")</td>
                                    <td>
                                        @if (c.Id == currentCodeId && c.ApprovalUsername == null)
                                        {
                                            <button class="btn btn-success btn-sm me-1" @onclick="() => ApproveCode(c.Id)">Approve</button>
                                            <button class="btn btn-danger btn-sm" @onclick="() => DisapproveCode(c.Id)">Disapprove</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            }

        </Authorized>

        <NotAuthorized>
            <p>Access denied.</p>
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState>

@code {
    // --- STATE ---
    string? searchCode;
    int? studentId;
    int? currentCodeId;

    List<UserDocument> documents = new();
    List<IBrowserFile> selectedFiles = new();
    List<StudentCode> codes = new();

    bool loadingDocuments = false;
    bool loadingCodes = false;

    private async Task LoadStudentByCode()
    {
        if (string.IsNullOrWhiteSpace(searchCode)) return;

        await Db.OpenAsync();

        var cmd = new MySqlCommand(
            "SELECT id, user_id FROM student_codes WHERE code = @code LIMIT 1",
            Db);
        cmd.Parameters.AddWithValue("@code", searchCode);

        using var reader = await cmd.ExecuteReaderAsync();
        if (!reader.Read())
        {
            studentId = null;
            currentCodeId = null;
            documents.Clear();
            codes.Clear();
            await Db.CloseAsync();
            return;
        }

        currentCodeId = reader.GetInt32("id");
        studentId = reader.GetInt32("user_id");
        await Db.CloseAsync();

        await LoadStudentDocuments();
        await LoadStudentCodes();
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        selectedFiles.Clear();
        foreach (var file in e.GetMultipleFiles())
            selectedFiles.Add(file);
    }

    private async Task UploadSelectedFiles()
    {
        if (selectedFiles.Count == 0 || studentId == null) return;

        var uploadFolder = Path.Combine("wwwroot", "uploads");
        if (!Directory.Exists(uploadFolder))
            Directory.CreateDirectory(uploadFolder);

        foreach (var file in selectedFiles)
        {
            var timestamp = DateTime.Now.ToString("yyyyMMddHHmmssfff");
            var uniqueName = $"{studentId}_{timestamp}_{file.Name}";
            var path = Path.Combine(uploadFolder, uniqueName);

            await using var fs = new FileStream(path, FileMode.Create);
            await file.OpenReadStream().CopyToAsync(fs);

            await Db.OpenAsync();
            var cmd = new MySqlCommand(
                "INSERT INTO user_documents(user_id, filename, file_path) VALUES (@uid, @fname, @fpath)",
                Db);
            cmd.Parameters.AddWithValue("@uid", studentId);
            cmd.Parameters.AddWithValue("@fname", file.Name);
            cmd.Parameters.AddWithValue("@fpath", $"/uploads/{uniqueName}");
            await cmd.ExecuteNonQueryAsync();
            await Db.CloseAsync();
        }

        selectedFiles.Clear();
        await LoadStudentDocuments();
    }

    private async Task LoadStudentDocuments()
    {
        if (studentId == null) return;

        loadingDocuments = true;
        documents.Clear();

        await Db.OpenAsync();
        var cmd = new MySqlCommand(
            "SELECT id, filename, file_path, uploaded_at FROM user_documents WHERE user_id=@uid ORDER BY uploaded_at DESC",
            Db);
        cmd.Parameters.AddWithValue("@uid", studentId);

        using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
        {
            documents.Add(new UserDocument
            {
                Id = reader.GetInt32("id"),
                Filename = reader.GetString("filename"),
                FilePath = reader.GetString("file_path"),
                UploadedAt = reader.GetDateTime("uploaded_at")
            });
        }
        await Db.CloseAsync();
        loadingDocuments = false;
    }

    private async Task LoadStudentCodes()
    {
        if (studentId == null) return;

        loadingCodes = true;
        codes.Clear();

        await Db.OpenAsync();
        var cmd = new MySqlCommand(@"
            SELECT sc.id, sc.code, sc.date_generated, sc.approved, sc.date_approved, sc.approval_userid, u.username AS approval_username
            FROM student_codes sc
            LEFT JOIN users u ON sc.approval_userid = u.id
            WHERE sc.user_id = @uid
            ORDER BY sc.date_generated DESC
        ", Db);
        cmd.Parameters.AddWithValue("@uid", studentId);

        using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
        {
            codes.Add(new StudentCode
            {
                Id = reader.GetInt32("id"),
                Code = reader.GetString("code"),
                DateGenerated = reader.GetDateTime("date_generated"),
                Approved = reader.GetBoolean("approved"),
                DateApproved = reader.IsDBNull(reader.GetOrdinal("date_approved")) ? null : reader.GetDateTime(reader.GetOrdinal("date_approved")),
                ApprovalUserId = reader.IsDBNull(reader.GetOrdinal("approval_userid")) ? null : reader.GetInt32(reader.GetOrdinal("approval_userid")),
                ApprovalUsername = reader.IsDBNull(reader.GetOrdinal("approval_username")) ? null : reader.GetString(reader.GetOrdinal("approval_username"))
            });
        }
        await Db.CloseAsync();
        loadingCodes = false;
    }

    private async Task ApproveCode(int codeId) => await UpdateCodeApproval(codeId, true);
    private async Task DisapproveCode(int codeId) => await UpdateCodeApproval(codeId, false);

    private async Task UpdateCodeApproval(int codeId, bool approved)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var facultyId = int.Parse(user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)!.Value);

        await Db.OpenAsync();
        var cmd = new MySqlCommand(
            "UPDATE student_codes SET approved=@approved, date_approved=NOW(), approval_userid=@facultyId WHERE id=@id AND approved=0",
            Db);
        cmd.Parameters.AddWithValue("@approved", approved);
        cmd.Parameters.AddWithValue("@facultyId", facultyId);
        cmd.Parameters.AddWithValue("@id", codeId);
        await cmd.ExecuteNonQueryAsync();
        await Db.CloseAsync();

        await LoadStudentCodes();
    }
}
