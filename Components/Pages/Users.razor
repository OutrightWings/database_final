@page "/Users"
@attribute [Authorize(Roles = "admin")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@inject MySqlConnection Db
@inject NavigationManager Nav

@rendermode InteractiveServer

<h3>All Users</h3>
<CascadingAuthenticationState>
    <AuthorizeView Roles="admin">
        <Authorized>
            @if (loading)
            {
                <p>Loading...</p>
            }
            else if (users.Count == 0)
            {
                <p>No users found.</p>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var u in users)
                        {
                            <tr>
                                <td>@u.Id</td>
                                <td>@u.Username</td>
                                <td>@u.Email</td>

                                <td>
                                    <select class="form-select form-select-sm"
                                            value="@u.Role"
                                            @onchange="e => ChangeRole(u.Id, e.Value!.ToString()!)">
                                        <option value="student">Student</option>
                                        <option value="faculty">Faculty</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </td>

                                <td>@u.Created.ToString("g")</td>

                                <td>
                                    <button class="btn btn-danger btn-sm"
                                            @onclick="() => DeleteUser(u.Id)">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <p class="text-danger">@error</p>
        </Authorized>

        <NotAuthorized>
            <p>Access denied.</p>
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState>
@code {
    List<UserModel> users = new();
    string error = "";
    bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    // LOAD USERS
    private async Task LoadUsers()
    {
        try
        {
            loading = true;
            users.Clear();

            await Db.OpenAsync();

            var cmd = new MySqlCommand(
                "SELECT id, username, email, role, create_datetime FROM users ORDER BY id ASC",
                Db);

            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                users.Add(new UserModel
                {
                    Id = reader.GetInt32("id"),
                    Username = reader.GetString("username"),
                    Email = reader.GetString("email"),
                    Role = reader.GetString("role"),
                    Created = reader.GetDateTime("create_datetime")
                });
            }
        }
        catch (Exception ex)
        {
            error = $"ERROR: {ex.Message}";
        }
        finally
        {
            await Db.CloseAsync();
            loading = false;
        }
    }

    // CHANGE USER ROLE
    private async Task ChangeRole(int userId, string newRole)
    {
        if (newRole != "student" && newRole != "faculty" && newRole != "admin")
            return;

        try
        {
            await Db.OpenAsync();

            var cmd = new MySqlCommand(
                "UPDATE users SET role=@r WHERE id=@id LIMIT 1",
                Db);

            cmd.Parameters.AddWithValue("@r", newRole);
            cmd.Parameters.AddWithValue("@id", userId);

            await cmd.ExecuteNonQueryAsync();
        }
        catch (Exception ex)
        {
            error = $"ERROR: {ex.Message}";
        }
        finally
        {
            await Db.CloseAsync();
        }

        await LoadUsers();
    }

    // DELETE USER
    private async Task DeleteUser(int id)
    {
        try
        {
            await Db.OpenAsync();

            var cmd = new MySqlCommand(
                "DELETE FROM users WHERE id=@id LIMIT 1",
                Db);

            cmd.Parameters.AddWithValue("@id", id);

            await cmd.ExecuteNonQueryAsync();
        }
        catch (Exception ex)
        {
            error = $"ERROR: {ex.Message}";
        }
        finally
        {
            await Db.CloseAsync();
        }

        await LoadUsers();
    }

    public class UserModel
    {
        public int Id { get; set; }
        public string Username { get; set; } = "";
        public string Email { get; set; } = "";
        public string Role { get; set; } = "";
        public DateTime Created { get; set; }
    }
}
